//= require easel
//= require tween
//= require lodash.core
function cya(gameData) {
  function width() {
    return window.innerWidth;
  }
  function height() {
    return window.innerHeight - document.getElementById("ChooseYourAdventure").offsetTop;
  }
  function percent(fn, amount) {
    return fn() * (amount / 100);
  }
  function percentY(amount) {
    return percent(height, amount);
  }
  function percentX(amount) {
    return percent(width, amount);
  }
  function resizeCanvas(stage) {
    stage.canvas.width = width();
    stage.canvas.height = height();
  }
  var stage = new createjs.Stage("ChooseYourAdventure");
  var fill = new createjs.Graphics()
    .beginFill('#000')
    .drawRect(0, 0, width(), height());
  var shape = new createjs.Shape(fill);
  var container = new createjs.Container();
  container.addChild(shape);
  stage.addChild(container);
  createjs.Ticker.setFPS(30);
  createjs.Ticker.addEventListener('tick', stage);
  resizeCanvas(stage);

  function getMainScreen() {
    var mainScreenContainer = new createjs.Container();
    var title = new createjs.Text(gameData.title, "20px Arial", gameData.fontColor);
    var titleBounds = title.getBounds();
    title.x = (width() - titleBounds.width) / 2;
    title.y = percentY(3);
    mainScreenContainer.addChild(title);
    var description = new createjs.Text(gameData.description, "18px Arial", gameData.fontColor);
    description.lineWidth = width() - 20;
    var descriptionBounds = description.getBounds();
    description.x = (width() - descriptionBounds.width) / 2;
    description.y = percentY(15);
    mainScreenContainer.addChild(description);
    var playButton = new createjs.Text('Play', '25px Arial', '#ADD8E6');
    var playButtonBounds = playButton.getBounds();
    playButton.x = (width() - playButtonBounds.width) / 2;
    playButton.y = percentY(90);
    mainScreenContainer.addChild(playButton);
    playButton.addEventListener('click', function() {
      var gameStage = 0;
      var level = 0;
      var node = null;
      //eventually look up saved state somewhere
      displayNode(gameStage, level, node);
      stage.removeChild(mainScreenContainer);
    });
    return mainScreenContainer;
  }
  stage.addChild(getMainScreen());

  //pointer to current game node
  var currentNodeContainer;

  function displayNode(gameStage, level, nodeId) {
    var stageData = gameData.stages[gameStage];
    if (!stageData) {
      throw 'No stage data found for index ' + gameStage;
    }
    var levelData = stageData.levels[level];
    if (!levelData) {
      throw 'No level data found for index ' + level;
    }
    var nodeContainer = new createjs.Container();
    if (nodeId) {
      //The specific node is known
      var nodeData = _.find(levelData.nodes, {
        id: nodeId
      });
      var description = new createjs.Text(nodeData.description, "18px Arial", gameData.fontColor);
      description.lineWidth = width() - 20;
      var descriptionBounds = description.getBounds();
      description.x = (width() - descriptionBounds.width) / 2;
      description.y = percentY(10);
      nodeContainer.addChild(description);
      _.each(nodeData.options, function(option, i) {
        var text = new createjs.Text(option.text, "14px Arial", gameData.fontColor);
        text.lineWidth = width() - 20;
        text.x = (width() - text.getBounds().width) / 2;
        text.y = percentY(90 - (i * 8));
        text.addEventListener('click', function() {
          displayNode(gameStage, level, option.ref);
        });
        nodeContainer.addChild(text);
      });
    } else {
      //This is a title screen for the stage + level
      var title = new createjs.Text(stageData.name, "20px Arial", gameData.fontColor);
      var titleBounds = title.getBounds();
      title.x = (width() - titleBounds.width) / 2;
      title.y = percentY(3);
      nodeContainer.addChild(title);
      var subTitle = new createjs.Text(levelData.name, "20px Arial", gameData.fontColor);
      var subTitleBounds = subTitle.getBounds();
      subTitle.x = (width() - subTitleBounds.width) / 2;
      subTitle.y = percentY(8);
      nodeContainer.addChild(subTitle);
      var description = new createjs.Text(levelData.description, "18px Arial", gameData.fontColor);
      description.lineWidth = width() - 20;
      var descriptionBounds = description.getBounds();
      description.x = (width() - descriptionBounds.width) / 2;
      description.y = percentY(20);
      nodeContainer.addChild(description);
      var playButton = new createjs.Text('Play', '25px Arial', '#ADD8E6');
      var playButtonBounds = playButton.getBounds();
      playButton.x = (width() - playButtonBounds.width) / 2;
      playButton.y = percentY(90);
      nodeContainer.addChild(playButton);
      playButton.addEventListener('click', function() {
        var node = 'start';
        displayNode(gameStage, level, node);
      });
    }

    if (currentNodeContainer) {
      stage.removeChild(currentNodeContainer);
    }
    stage.addChild(nodeContainer);
    stage.update();
    currentNodeContainer = nodeContainer;
  }
}
